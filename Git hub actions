GITHUB Actions code


name: End-to-End CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:

env:
  APP_NAME: my-app
  AWS_REGION: ap-south-1
  ECR_REPO: my-app
  IMAGE_TAG: ${{ github.sha }}

jobs:
  cicd:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout Code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Setup Java
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # 3Ô∏è‚É£ Compile
    - name: Compile Code
      run: mvn clean compile

    # 4Ô∏è‚É£ Unit Tests
    - name: Run Unit Tests
      run: mvn test

    # 5Ô∏è‚É£ SonarQube Scan
    - name: SonarQube Scan
      run: |
        mvn sonar:sonar \
        -Dsonar.projectKey=my-project \
        -Dsonar.host.url=${{ secrets.SONAR_URL }} \
        -Dsonar.login=${{ secrets.SONAR_TOKEN }}

    # 6Ô∏è‚É£ OWASP Dependency Check
    - name: OWASP Dependency Check
      run: |
        mvn org.owasp:dependency-check-maven:check

    # 7Ô∏è‚É£ Build JAR/WAR
    - name: Build Artifact
      run: mvn package -DskipTests

    # 8Ô∏è‚É£ Trivy Scan - Artifact
    - name: Trivy File Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: fs
        scan-ref: target/

    # 9Ô∏è‚É£ Push Artifact to Nexus
    - name: Push to Nexus
      run: |
        mvn deploy \
        -Dnexus.username=${{ secrets.NEXUS_USER }} \
        -Dnexus.password=${{ secrets.NEXUS_PASS }}

    # üîü Configure AWS
    - name: Configure AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # 1Ô∏è‚É£1Ô∏è‚É£ Login to ECR
    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2

    # 1Ô∏è‚É£2Ô∏è‚É£ Docker Build
    - name: Build Docker Image
      run: |
        docker build -t $ECR_REPO:$IMAGE_TAG .
        docker tag $ECR_REPO:$IMAGE_TAG \
        ${{ secrets.ECR_URL }}/$ECR_REPO:$IMAGE_TAG

    # 1Ô∏è‚É£3Ô∏è‚É£ Trivy Scan - Image
    - name: Trivy Image Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ secrets.ECR_URL }}/$ECR_REPO:$IMAGE_TAG
        format: table
        exit-code: 0

    # 1Ô∏è‚É£4Ô∏è‚É£ Push Image to ECR
    - name: Push to ECR
      run: |
        docker push ${{ secrets.ECR_URL }}/$ECR_REPO:$IMAGE_TAG

    # 1Ô∏è‚É£5Ô∏è‚É£ Setup Kubectl
    - name: Setup Kubectl
      uses: azure/setup-kubectl@v4

    # 1Ô∏è‚É£6Ô∏è‚É£ Configure Kubeconfig
    - name: Configure K8s
      run: |
        echo "${{ secrets.KUBE_CONFIG }}" > kubeconfig
        export KUBECONFIG=$PWD/kubeconfig

    # 1Ô∏è‚É£7Ô∏è‚É£ Deploy to Kubernetes
    - name: Deploy to K8s
      run: |
        kubectl set image deployment/my-app \
        my-app=${{ secrets.ECR_URL }}/$ECR_REPO:$IMAGE_TAG
